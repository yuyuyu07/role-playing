# streamlit_role_playing.py
import streamlit as st  # å¯¼å…¥Streamlitåº“ï¼Œç”¨äºåˆ›å»ºWebåº”ç”¨ç•Œé¢
from openai_role_playing import get_gemini_response  # ä»æˆ‘ä»¬åˆ›å»ºçš„ openai_å¯¹è¯.py æ–‡ä»¶ä¸­å¯¼å…¥å‡½æ•°
import os

# --- ä¾§è¾¹æ  ---
with st.sidebar:  # ä¾§è¾¹æ  å¸ƒå±€
    st_api_key = st.text_input("è¯·è¾“å…¥APIå¯†é’¥:", type="password")  # å¯†ç  è¾“å…¥æ¡† # è¿”å› æ–‡å­—
    st.markdown("[APIè·å–åœ°å€](https://ai.google.dev/gemini-api/docs?hl=zh-cn)")
    st_gemini_model = st.text_input("å½“å‰ä½¿ç”¨æ¨¡å‹:", value="gemini-3-flash-preview")  # å¯†ç  è¾“å…¥æ¡† # è¿”å› æ–‡å­—
    st.markdown("[æ¨¡å‹è·å–åœ°å€](https://ai.google.dev/gemini-api/docs/models?hl=zh-cn)")
    st.markdown("---")

    # +------------------------------------------------------------------+
    # |                            è§’è‰²æ‰®æ¼”                               |
    # +------------------------------------------------------------------+
    # æ–‡ä»¶ä¸Šä¼ å™¨
    uploaded_file = st.file_uploader("ä¸Šä¼ æ–‡ä»¶æ–‡æ¡£ï¼Œæ–‡æ¡£ç±»å‹ï¼ˆmdï¼‰",
                                  type=["md"])  # æ–‡ä»¶ä¸Šä¼  å™¨ # è¿”å› UploaderFileç±»çš„å¯¹è±¡(å®ä¾‹)

    if not uploaded_file:  # å¦‚æœ ç‚¹å‡»æŒ‰é’® å¹¶æ²¡æœ‰ è¾“å…¥ AIPå¯†é’¥
        st.info("è¯·ä¸Šä¼ è§’è‰²æ–‡ä»¶")  # æé†’ æç¤º
        st.stop()  # ç»ˆæ­¢ # ç±»ä¼¼break

    file_content = uploaded_file.read()  # è¿™ä¸ª.read() ã€‚è¿”å›bytesçš„å†…å®¹ï¼ˆäºŒè¿›åˆ¶æ•°æ®ï¼‰
    temp_file_path = "temp.md"          # ä¿å­˜ ä¸´æ—¶æ–‡ä»¶
    # åˆ›å»º&å†™å…¥ äºŒè¿›åˆ¶å†…å®¹ â€”â€”> ä¸´æ—¶æ–‡ä»¶ï¼ˆ"temp.pdf"ï¼‰
    with open(temp_file_path, "wb") as temp_file:  # æ–‡ä»¶ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»º # äºŒè¿›åˆ¶ä¸ç”¨ç¼–ç æ–¹å¼
        temp_file.write(file_content)  # æŠŠäºŒè¿›åˆ¶å†…å®¹å†™å…¥ä¸´æ—¶æ–‡ä»¶ä¸­
    # è¯»ä¸´æ—¶æ–‡ä»¶
    with open(temp_file_path, "r", encoding="utf8") as f:  # è·å–txtæ–‡ä»¶
        ç³»ç»Ÿ = f.read()

    st.text(f"{uploaded_file.name}")  # æ˜¾ç¤ºæ–‡ä»¶å

    # +------------------------------------------------------------------+
    # |                            æ¸…é™¤èŠå¤©è®°å½•æŒ‰é’®                         |
    # +------------------------------------------------------------------+


    # æ¸…é™¤èŠå¤©è®°å½•æŒ‰é’®
    if st.button("æ¸…é™¤èŠå¤©è®°å½•"):
        st.session_state["messages"] = [{"role": "system", "content": ç³»ç»Ÿ}]
        st.rerun()  # é‡æ–°è¿è¡Œåº”ç”¨ä»¥æ›´æ–°ç•Œé¢

# --- åº”ç”¨æ ‡é¢˜ ---
st.title("ğŸ’¬ Gemini è§’è‰²æ‰®æ¼”")  # è®¾ç½®ç½‘é¡µåº”ç”¨çš„æ ‡é¢˜

# +------------------------------------------------------------------+
# |                             æäº¤å‰ æ£€æŸ¥                            |
# +------------------------------------------------------------------+
# æ£€æµ‹api_keyæ˜¯å¦è¾“å…¥:
if not st_api_key:  # å¦‚æœ ç‚¹å‡»æŒ‰é’® å¹¶æ²¡æœ‰ è¾“å…¥ AIPå¯†é’¥
    st.info("è¯·è¾“å…¥APIå¯†é’¥")  # æé†’ æç¤º
    st.stop()               # ç»ˆæ­¢ # ç±»ä¼¼break

# +------------------------------------------------------------------+
# |                            åˆ›å»º æ˜¾ç¤ºæ¶ˆæ¯ï¼ˆä¼šè¯çŠ¶æ€ï¼‰                  |
# +------------------------------------------------------------------+
# åˆ›å»º æ¬¢è¿ä»‹ç»ï¼ˆä¼šè¯çŠ¶æ€ï¼‰
# if ç³»ç»Ÿ is None:
# # æ£€æµ‹api_keyæ˜¯å¦è¾“å…¥:
# # if st_æŒ‰é’® and not st_api_key:  # å¦‚æœ ç‚¹å‡»æŒ‰é’® å¹¶æ²¡æœ‰ è¾“å…¥ AIPå¯†é’¥
#     st.info("è¯·è¾“å…¥APIå¯†é’¥")  # æé†’ æç¤º
#     st.stop()               # ç»ˆæ­¢ # ç±»ä¼¼break
if "messages" not in st.session_state:                   # æ£€æŸ¥ä¼šè¯çŠ¶æ€ä¸­æ˜¯å¦å­˜åœ¨ "messages" é”®
    # "messages"å˜é‡å å’Œ è®°å¿†é‡Œçš„ messages=[]å˜é‡å ä¸€è‡´
    st.session_state["messages"] = [{"role": "system", "content": ç³»ç»Ÿ}]

# +------------------------------------------------------------------+
# |                            æ˜¾ç¤º æ‰€æœ‰èŠå¤©æ¶ˆæ¯                        |
# +------------------------------------------------------------------+
# forå¾ªç¯éå†ä¼šè¯çŠ¶æ€ä¸­çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œ.chat_messageæ–¹æ³• ç”¨å¹¶å°†å®ƒä»¬æ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢ä¸Š
for i in st.session_state["messages"]:              # éå† "st.session_state.messages" åˆ—è¡¨ä¸­çš„æ¯ä¸€æ¡æ¶ˆæ¯
    # ä½¿ç”¨ st.chat_message æ˜¾ç¤ºæ¶ˆæ¯ï¼Œ
    if i["role"] != "system":  # !!! å…³é”®æ”¹åŠ¨ï¼šå¦‚æœæ¶ˆæ¯çš„è§’è‰²ä¸æ˜¯ "system"ï¼Œæ‰æ˜¾ç¤ºå®ƒ
        st.chat_message(i["role"]).write(i["content"])  # æ¶ˆæ¯çš„è§’è‰²ï¼ˆ"user" æˆ– "assistant"ï¼‰å†³å®šäº†æ¶ˆæ¯çš„æ˜¾ç¤ºæ ·å¼ï¼Œå¹¶ä½¿ç”¨ st.write æ˜¾ç¤ºæ¶ˆæ¯å†…å®¹

# +------------------------------------------------------------------+
# |                            è·å–ç”¨æˆ·è¾“å…¥                            |
# +------------------------------------------------------------------+
# å°†æ–‡æœ¬è¾“å…¥å’Œæäº¤æŒ‰é’®æ”¾åœ¨å†å²æ¶ˆæ¯ä¹‹åï¼ˆé»˜è®¤åœ¨æœ€ä½ç«¯ï¼‰
prompt = st.chat_input("è¾“å…¥èŠå¤©æ¶ˆæ¯")  # èŠå¤© è¾“å…¥æ¡†  # ä¸å¡«ä¸ºè‹±æ–‡"Your message"

# +------------------------------------------------------------------+
# |                            å¤„ç†ç”¨æˆ·è¾“å…¥                            |
# +------------------------------------------------------------------+
if prompt:  # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¾“å…¥äº†å†…å®¹
    # +------------------------------------------------------------------+
    # |                         å°†ç”¨æˆ·æ¶ˆæ¯æ·»åŠ åˆ°å†å²ä¸­                       |
    # +------------------------------------------------------------------+
    # å°†ç”¨æˆ·æ¶ˆæ¯ æ·»åŠ åˆ°ä¼šè¯çŠ¶æ€  ".append()åˆ—è¡¨æ·»åŠ æ–¹å¼" å°†å­—å…¸çœ‹ä½œä¸€ä¸ªå…ƒç´ æ·»åŠ åˆ°åˆ—è¡¨ä¸­
    st.session_state["messages"].append({"role": "user", "content": prompt})  # å°†ç”¨æˆ·æ¶ˆæ¯æ·»åŠ åˆ°ä¼šè¯çŠ¶æ€çš„ "messages" åˆ—è¡¨ä¸­
    # æ˜¾ç¤º ç”¨æˆ·èŠå¤©ä¿¡æ¯
    st.chat_message("user").write(prompt)  # åœ¨èŠå¤©ç•Œé¢ä¸Šæ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯

    # +------------------------------------------------------------------+
    # |                           è®°å¿†ï¼ˆå†å²æ¶ˆæ¯åˆ—è¡¨ï¼‰                       |
    # +------------------------------------------------------------------+
    # 2. å‡†å¤‡å‘é€ç»™APIçš„èŠå¤©å†å² (å½“å‰æ‰€æœ‰æ¶ˆæ¯)
    messages_history = st.session_state["messages"]

    # +------------------------------------------------------------------+
    # |                             è·å¾—AIæ¶ˆæ¯                             |
    # +------------------------------------------------------------------+
    with st.spinner("AI æ­£åœ¨æ€è€ƒä¸­..."):  # æ˜¾ç¤ºåŠ è½½æç¤º
        # è°ƒç”¨ get_gemini_response å‡½æ•°
        response = get_gemini_response(st_api_key,messages_history,st_gemini_model)  # ä¼ å…¥å½“å‰çš„èŠå¤©å†å²

    # +------------------------------------------------------------------+
    # |                          å°†AIæ¶ˆæ¯æ·»åŠ åˆ°å†å²ä¸­                        |
    # +------------------------------------------------------------------+
    # å°†AIå†…å®¹ æ·»åŠ åˆ°ä¼šè¯çŠ¶æ€ ".append()åˆ—è¡¨æ·»åŠ æ–¹å¼" å°†å­—å…¸çœ‹ä½œä¸€ä¸ªå…ƒç´ æ·»åŠ åˆ°åˆ—è¡¨ä¸­
    st.session_state["messages"].append({"role": "assistant", "content": response["content"]})  # å°† AI åŠ©æ‰‹çš„æ¶ˆæ¯æ·»åŠ åˆ°ä¼šè¯çŠ¶æ€çš„ "messages" åˆ—è¡¨ä¸­
    # æ˜¾ç¤º AIå†…å®¹
    st.chat_message("assistant").write(response["content"])  # åœ¨èŠå¤©ç•Œé¢ä¸Šæ˜¾ç¤º AI åŠ©æ‰‹çš„æ¶ˆæ¯
